<% var useTbcareTheme = true; %>
<%- include('../../includes/head.ejs') %>
<style>
    #content-page {
        background: linear-gradient(135deg, #f0fdfa 0%, #eff6ff 50%, #fef2f2 100%);
        background-attachment: fixed;
        min-height: 100vh;
    }
    .iq-card {
        border-radius: 1rem;
        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        border: none;
        transition: all 0.3s ease;
    }
    .iq-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 30px rgba(0,0,0,0.12);
    }
    .iq-card-icon {
        width: 60px;
        height: 60px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.8rem;
        box-shadow: 0 4px 15px rgba(0,0,0,0.15);
    }
    .iq-card-icon.bg-primary {
        background: linear-gradient(135deg, #14b8a6, #0ea5e9) !important;
    }
    .iq-card-icon.bg-danger {
        background: linear-gradient(135deg, #ef4444, #f97316) !important;
    }
    .iq-card-header {
        border-bottom: 2px solid #f0f0f0;
        padding: 1.5rem;
    }
    .iq-card-header .card-title {
        font-weight: 700;
        color: #0f172a;
        font-size: 1.3rem;
    }
    .btn-primary {
        background: linear-gradient(135deg, #14b8a6, #0ea5e9);
        border: none;
        font-weight: 600;
        border-radius: 0.5rem;
        padding: 0.6rem 1.5rem;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(20, 184, 166, 0.3);
    }
    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(20, 184, 166, 0.4);
        background: linear-gradient(135deg, #0ea5e9, #3b82f6);
    }
    .table-responsive {
        border-radius: 0.75rem;
        overflow: hidden;
    }
    .table thead {
        background: linear-gradient(135deg, #0f172a, #1e293b);
        color: white;
    }
    .table thead th {
        font-weight: 700;
        text-transform: uppercase;
        font-size: 0.85rem;
        letter-spacing: 0.5px;
        padding: 1rem;
    }
    .table-striped tbody tr:nth-of-type(odd) {
        background-color: rgba(13, 148, 136, 0.03);
    }
    .table tbody tr {
        transition: all 0.2s ease;
    }
    .table tbody tr:hover {
        background-color: rgba(13, 148, 136, 0.08);
        transform: scale(1.01);
    }
    .btn-sm {
        border-radius: 0.4rem;
        font-weight: 600;
        padding: 0.4rem 0.8rem;
        transition: all 0.2s ease;
    }
    .btn-sm:hover {
        transform: scale(1.1);
    }
    h2.counter {
        font-weight: 800;
        background: linear-gradient(135deg, #14b8a6, #0ea5e9);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }
    /* page header style to match TB Care pages */
    .page-header-card {
        background: linear-gradient(135deg, #667eea 0%, #24be90 100%);
        border-radius: 15px;
        padding: 24px 30px;
        margin-bottom: 24px;
        box-shadow: 0 10px 30px rgba(102, 126, 234, 0.18);
    }
    .page-header-card h2 {
        color: white;
        font-weight: 700;
        margin: 0;
        font-size: 1.4rem;
    }
    .page-header-card p {
        color: rgba(255,255,255,0.95);
        margin: 6px 0 0 0;
        font-size: 0.95rem;
        opacity: 0.95;
    }
    .page-header-greeting { display:flex; gap:16px; align-items:center }
    .page-header-greeting .avatar-badge {
        width:56px; height:56px; border-radius:12px; display:flex;align-items:center;justify-content:center;
        background: rgba(255,255,255,0.12); color: white; font-weight:700; font-size:1.1rem;
        box-shadow: 0 6px 18px rgba(16,24,40,0.08);
    }
</style>
</head>
<body>
   <div class="wrapper">
      <%- include('../../includes/navigations-tbcare.ejs') %>
      <div id="content-page" class="content-page">
         <%- include('../../includes/tbcare/top-navbar.ejs') %>
         <div class="container-fluid">
            <!-- Page Header (greeting for doctor) -->
            <% /* defensive resolution for doctor name: prefer userdata.userName, then doctorName, then user.fullName, then user.name, else 'Dokter' */ %>
            <% var __doctorDisplayName = (typeof userdata !== 'undefined' && userdata && userdata.userName) ? userdata.userName : ((typeof doctorName !== 'undefined') ? doctorName : (typeof user !== 'undefined' && user && user.fullName && user.fullName.first ? user.fullName.first + (user.fullName.last ? ' ' + user.fullName.last : '') : (typeof user !== 'undefined' && user && user.name ? user.name : 'Dokter'))); %>
            <div class="row">
                <div class="col-12">
                    <div class="page-header-card">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="page-header-greeting">
                                <div class="avatar-badge"><%= (__doctorDisplayName.split(' ').map(n=>n[0]).slice(0,2).join('')).toUpperCase() %></div>
                                <div>
                                    <h2>Hi, <%= __doctorDisplayName %></h2>
                                    <p data-i18n="page.welcomeSubtitle">Welcome back — here’s a quick overview of your TB Care dashboard.</p>
                                </div>
                            </div>
                            <div class="text-white">
                                <small style="opacity:0.95">Today: <%= (new Date()).toLocaleDateString('id-ID', { weekday: 'long', day: 'numeric', month: 'long' }) %></small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-6 col-lg-3">
                    <div class="iq-card iq-card-block iq-card-stretch iq-card-height">
                        <div class="iq-card-body">
                            <div class="d-flex align-items-center">
                                <div class="rounded-circle iq-card-icon bg-primary"><i class="ri-user-line"></i></div>
                                <div class="text-left ml-3">
                                    <h2 class="mb-0"><span class="counter"><%= totalPatientCount %></span></h2>
                                    <h5 class="">Total Pasien</h5>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 col-lg-3">
                    <div class="iq-card iq-card-block iq-card-stretch iq-card-height">
                        <div class="iq-card-body">
                            <div class="d-flex align-items-center">
                                <div class="rounded-circle iq-card-icon bg-danger"><i class="ri-checkbox-circle-line"></i></div>
                                <div class="text-left ml-3">
                                    <h2 class="mb-0"><span class="counter"><%= tbCasesCount %></span></h2>
                                    <h5 class="">Kasus TB Ditemukan</h5>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-lg-12">
                    <div class="iq-card iq-card-block iq-card-stretch iq-card-height">
                         <div class="iq-card-header d-flex justify-content-between">
                            <div class="iq-header-title">
                               <h4 class="card-title">Statistik Pasien per Kecamatan (Surabaya)</h4>
                            </div>
                         </div>
                        <div class="iq-card-body">
                            <canvas id="regionalBarChart" style="height: 400px;"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
               <div class="col-sm-12">
                  <div class="iq-card">
                     <div class="iq-card-header d-flex justify-content-between">
                        <div class="iq-header-title">
                           <h4 class="card-title">TBCare Patient List</h4>
                        </div>
                        <div class="iq-card-header-toolbar d-flex align-items-center">
                           <a href="/tbcare/add-patient" class="btn btn-primary">Add New Patient</a>
                        </div>
                     </div>
                     <div class="iq-card-body">
                        <div class="table-responsive">
                           <table class="table table-striped table-bordered">
                              <thead>
                                 <tr>
                                    <th>Name</th>
                                    <th>Contact</th>
                                    <th>Email</th>
                                    <th>City/District</th>
                                    <th>Action</th>
                                 </tr>
                              </thead>
                              <tbody>
                                 <% if(pasien.length > 0) { %>
                                    <% pasien.forEach(p => { %>
                                       <tr>
                                          <td><%= p.fullName.first %> <%= p.fullName.last %></td>
                                          <td><%= p.mobileNumber1 || 'N/A' %></td>
                                          <td><%= p.email %></td>
                                          <td>
                                            <% if (p.tbcareProfile && (p.tbcareProfile.city || p.tbcareProfile.district)) { %>
                                                <%= `${p.tbcareProfile.city || ''}${p.tbcareProfile.city && p.tbcareProfile.district ? ', ' : ''}${p.tbcareProfile.district || ''}` %>
                                            <% } else { %>
                                                N/A
                                            <% } %>
                                          </td>
                                          <td>
                                             <div class="d-flex align-items-center">
                                                <a class="btn btn-sm btn-primary mr-2" data-toggle="tooltip" title="View History" href="/tbcare/patient-history/<%= p._id %>"><i class="ri-eye-line"></i></a>
                                                <a class="btn btn-sm btn-info mr-2" data-toggle="tooltip" title="Edit Patient" href="/tbcare/edit-patient/<%= p._id %>"><i class="ri-pencil-line"></i></a>
                                                <form action="/tbcare/delete-patient" method="POST" onsubmit="return confirm('Are you sure you want to delete this patient?');" style="display: inline;">
                                                   <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                                                   <input type="hidden" name="patientId" value="<%= p._id %>">
                                                   <button type="submit" class="btn btn-sm btn-danger" data-toggle="tooltip" title="Delete Patient"><i class="ri-delete-bin-line"></i></button>
                                                </form>
                                             </div>
                                          </td>
                                       </tr>
                                    <% }) %>
                                 <% } else { %>
                                    <tr>
                                       <td colspan="5" class="text-center">No patients found.</td>
                                    </tr>
                                 <% } %>
                              </tbody>
                           </table>
                        </div>
                     </div>
                  </div>
               </div>
            </div>
         </div>
         <%- include('../../includes/footer.ejs') %>
         </div>
   </div>
    <%- include('../../includes/tbcare/end.ejs') %>

   <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
   <script>
   document.addEventListener('DOMContentLoaded', function () {
       const ctx = document.getElementById('regionalBarChart');
       if (ctx) {
           const regionalStatsData = <%- JSON.stringify(regionalStats || {}) %>;
           const labels = Object.keys(regionalStatsData);
           const data = Object.values(regionalStatsData);

           new Chart(ctx, {
               type: 'bar',
               data: {
                   labels: labels,
                   datasets: [{
                       label: 'Jumlah Pasien',
                       data: data,
                       backgroundColor: 'rgba(54, 162, 235, 0.6)',
                       borderColor: 'rgba(54, 162, 235, 1)',
                       borderWidth: 1
                   }]
               },
               options: {
                   scales: {
                       y: { beginAtZero: true, ticks: { stepSize: 1 } }
                   },
                   responsive: true,
                   maintainAspectRatio: false
               }
           });
       }
   });
   </script>
</body>
</html>