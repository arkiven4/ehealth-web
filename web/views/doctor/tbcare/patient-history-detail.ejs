<% var useTbcareTheme = true; %>
<%- include('../../includes/head.ejs') %>
<style>
    /* Style sederhana untuk modal, bisa disesuaikan */
    .modal {
        display: none; position: fixed; z-index: 1050; left: 0; top: 0;
        width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4);
    }
    .modal-content {
        background-color: #fefefe; margin: 10% auto; padding: 20px;
        border: 1px solid #888; width: 80%; max-width: 600px; border-radius: 8px;
    }
    .close-button { color: #aaa; float: right; font-size: 28px; font-weight: bold; }
    .close-button:hover, .close-button:focus { color: black; text-decoration: none; cursor: pointer; }
</style>
</head>
<body>
<div class="wrapper">
    <%- include('../../includes/navigations-tbcare.ejs') %>
    <div id="content-page" class="content-page">
        <%- include('../../includes/tbcare/top-navbar.ejs') %>
        <div class="container-fluid">
            <div class="row">
                <div class="col-sm-12">
                    <div class="iq-card">
                            <div class="iq-card-header d-flex justify-content-between">
                            <div class="iq-header-title">
                                <h4 class="card-title">Riwayat: <%= patient.fullName.first %> <%= patient.fullName.last %></h4>
                                <p>ID Partisipan: <%= patient.tbcareProfile ? patient.tbcareProfile.participantId : 'N/A' %></p>
                            </div>
                            <a href="/tbcare/patient-history" class="btn btn-secondary">Kembali ke Daftar Pasien</a>
                        </div>
                        <div class="iq-card-body">
                            <div class="table-responsive">
                                <table class="table table-striped table-bordered">
                                    <thead>
                                        <tr>
                                            <th>Tanggal</th>
                                            <th>Hasil</th>
                                            <% if (enableSputumFields) { %>
                                            <th>Dahak</th>
                                            <% } %>
                                            <th>Status Validasi</th>
                                            <th>Segmen (TB/Total)</th>
                                            <th>Diprediksi Oleh</th>
                                            <th>Aksi</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <% if (predictions && predictions.length > 0) { %>
                                            <% predictions.forEach(pred => { %>
                                                <tr id="pred-row-<%= pred._id %>">
                                                    <td data-label="date"><%= new Date(pred.createdAt).toLocaleString() %></td>
                                                    <td data-label="result">
                                                        <span class="badge <%= pred.result === 'TB' ? 'badge-danger' : 'badge-success' %>">
                                                            <%= pred.result %>
                                                        </span>
                                                    </td>
                                                    <% if (enableSputumFields) { %>
                                                    <td data-label="sputum"><%= pred.sputumCondition || '-' %></td>
                                                    <% } %>
                                                    <td data-label="validation">
                                                        <% 
                                                        const vStatus = pred.validationStatus || 'pending';
                                                        %>
                                                        <% if (vStatus === 'accepted') { %>
                                                            <span class="badge badge-success">
                                                                <i class="ri-checkbox-circle-line"></i> DITERIMA
                                                            </span>
                                                            <br><small class="text-muted"><%= pred.validatedAt ? new Date(pred.validatedAt).toLocaleDateString('id-ID') : '' %></small>
                                                        <% } else if (vStatus === 'rejected') { %>
                                                            <span class="badge badge-danger">
                                                                <i class="ri-close-circle-line"></i> DITOLAK
                                                            </span>
                                                            <br><small class="text-muted"><%= pred.validatedAt ? new Date(pred.validatedAt).toLocaleDateString('id-ID') : '' %></small>
                                                        <% } else { %>
                                                            <span class="badge badge-warning">
                                                                <i class="ri-time-line"></i> Pending
                                                            </span>
                                                        <% } %>
                                                    </td>
                                                    <td data-label="segments"><%= pred.tbSegmentCount %> / <%= pred.totalCoughSegments %></td>
                                                    <td data-label="doctor">Dr. <%= pred.predictedBy ? pred.predictedBy.userName : 'N/A' %></td>
                                                    <td>
                                                        <a href="/tbcare/history/<%= pred._id %>" class="btn btn-sm btn-primary" title="Lihat Detail Lengkap">
                                                            <i class="ri-eye-line"></i> Lihat
                                                        </a>
                                                        <% if (enableSputumFields) { %>
                                                        <button class="btn btn-sm btn-info edit-btn" data-id="<%= pred._id %>" data-sputum="<%= pred.sputumCondition %>">
                                                            <i class="ri-edit-line"></i> Edit
                                                        </button>
                                                        <% } %>
                                                        
                                                        <!-- Validation Buttons with Accept/Reject/Reset -->
                                                        <% if (vStatus === 'pending') { %>
                                                            <button class="btn btn-sm btn-success validation-action-btn" 
                                                                    data-id="<%= pred._id %>" 
                                                                    data-action="accepted"
                                                                    title="Terima Prediksi">
                                                                <i class="ri-checkbox-circle-line"></i> Accept
                                                            </button>
                                                            <button class="btn btn-sm btn-danger validation-action-btn" 
                                                                    data-id="<%= pred._id %>" 
                                                                    data-action="rejected"
                                                                    title="Tolak Prediksi">
                                                                <i class="ri-close-circle-line"></i> Reject
                                                            </button>
                                                        <% } else { %>
                                                            <button class="btn btn-sm btn-secondary validation-action-btn" 
                                                                    data-id="<%= pred._id %>" 
                                                                    data-action="pending"
                                                                    title="Reset ke Pending">
                                                                <i class="ri-refresh-line"></i> Reset
                                                            </button>
                                                        <% } %>
                                                        
                                                        <button class="btn btn-sm btn-danger delete-btn" data-id="<%= pred._id %>">
                                                            <i class="ri-delete-bin-line"></i> Hapus
                                                        </button>
                                                    </td>
                                                </tr>
                                            <% }) %>
                                        <% } else { %>
                                            <tr>
                                                <td colspan="<%= enableSputumFields ? 7 : 7 %>" class="text-center text-muted">Tidak ada riwayat prediksi ditemukan.</td>
                                            </tr>
                                        <% } %>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <%- include('../../includes/footer.ejs') %>
    </div>
</div>

<div id="editModal" class="modal" style="<%= enableSputumFields ? '' : 'display: none !important;' %>">
    <div class="modal-content">
        <span class="close-button">&times;</span>
        <h3>Edit Catatan Prediksi</h3>
        <hr>
        <form id="editForm">
            <input type="hidden" id="editPredictionId" name="predictionId">
            <div class="form-group">
                <label for="newParticipantId">Pindah ke Pasien Lain (Opsional):</label>
                <input type="text" class="form-control" id="newParticipantId" placeholder="Masukkan ID Partisipan baru">
            </div>
            <% if (enableSputumFields) { %>
            <div class="row">
                <div class="form-group col-md-6">
                    <label for="editSputumStatus">Kondisi Dahak:</label>
                    <select class="form-control" id="editSputumStatus" name="sputumStatus">
                        <option value="Sputum +">Dahak +</option>
                        <option value="Sputum -">Dahak -</option>
                    </select>
                </div>
                <div class="form-group col-md-6" id="editSputumLevelContainer">
                    <label for="editSputumLevel">Level Dahak+:</label>
                    <select class="form-control" id="editSputumLevel" name="sputumLevel">
                        <option value="Low">Rendah</option>
                        <option value="Moderate">Sedang</option>
                        <option value="High">Tinggi</option>
                    </select>
                </div>
            </div>
            <% } %>
            <hr>
            <button type="button" class="btn iq-bg-danger" id="closeModalBtn">Batal</button>
            <button type="submit" class="btn btn-primary">Simpan Perubahan</button>
        </form>
    </div>
</div>
    
<script>
document.addEventListener('DOMContentLoaded', function() {
    const csrfToken = "<%= csrfToken %>";
    const modal = document.getElementById('editModal');
    const closeModalElements = document.querySelectorAll('.close-button, #closeModalBtn');

    // --- LOGIKA UNTUK EDIT ---
    const enableSputumFields = <%= enableSputumFields ? 'true' : 'false' %>;
    
    if (enableSputumFields) {
        document.querySelectorAll('.edit-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const predictionId = this.dataset.id;
                const currentSputum = this.dataset.sputum;

                // Isi form modal dengan data saat ini
                document.getElementById('editPredictionId').value = predictionId;
                
                if (currentSputum.includes('Sputum +')) {
                    document.getElementById('editSputumStatus').value = 'Sputum +';
                    document.getElementById('editSputumLevelContainer').style.display = 'block';
                    if (currentSputum.includes('Low')) document.getElementById('editSputumLevel').value = 'Low';
                    else if (currentSputum.includes('Moderate')) document.getElementById('editSputumLevel').value = 'Moderate';
                    else if (currentSputum.includes('High')) document.getElementById('editSputumLevel').value = 'High';
                } else {
                    document.getElementById('editSputumStatus').value = 'Sputum -';
                    document.getElementById('editSputumLevelContainer').style.display = 'none';
                }

                modal.style.display = 'block';
            });
        });

        document.getElementById('editSputumStatus').addEventListener('change', function() {
            document.getElementById('editSputumLevelContainer').style.display = this.value === 'Sputum +' ? 'block' : 'none';
        });
    }

    // --- LOGIKA UNTUK VALIDASI (Accept/Reject/Reset) ---
    document.querySelectorAll('.validation-action-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const predictionId = this.dataset.id;
            const action = this.dataset.action; // 'accepted', 'rejected', or 'pending'
            
            const actionMessages = {
                accepted: 'menerima (ACCEPT)',
                rejected: 'menolak (REJECT)',
                pending: 'mereset status validasi'
            };
            
            const confirmMsg = `Apakah Anda yakin ingin ${actionMessages[action]} prediksi ini?`;
            
            if (confirm(confirmMsg)) {
                // Optional: ask for note if rejecting
                let note = null;
                if (action === 'rejected') {
                    note = prompt('Alasan penolakan (opsional):');
                }
                
                fetch('/api/prediction/' + predictionId + '/validate', {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'csrf-token': csrfToken
                    },
                    body: JSON.stringify({ 
                        validationStatus: action,
                        note: note 
                    })
                })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert('Error: ' + (data.message || 'Gagal mengupdate status validasi'));
                    }
                })
                .catch(err => {
                    console.error(err);
                    alert('Terjadi kesalahan saat mengupdate status validasi.');
                });
            }
        });
    });
    
    if (enableSputumFields) {
        document.getElementById('editForm').addEventListener('submit', function(event) {
        event.preventDefault();
        const predictionId = document.getElementById('editPredictionId').value;
        
        const bodyData = {
            sputumStatus: document.getElementById('editSputumStatus').value,
            sputumLevel: document.getElementById('editSputumLevel').value
        };

        const newParticipantId = document.getElementById('newParticipantId').value;
        if (newParticipantId.trim() !== '') {
            bodyData.newParticipantId = newParticipantId.trim();
        }

        fetch('/api/prediction/' + predictionId, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'csrf-token': csrfToken
            },
            body: JSON.stringify(bodyData)
        })
        .then(res => res.json())
        .then(data => {
            if (data.message.includes('diperbarui')) {
                // Jika berhasil, update data di tabel
                const row = document.getElementById('pred-row-' + predictionId);
                if (newParticipantId) {
                    // Jika pasien dipindah, hapus baris dari view ini
                    row.remove();
                    alert('Berhasil diupdate! Catatan telah dipindah ke pasien lain.');
                } else {
                    // Jika hanya update dahak, perbarui teks di tabel
                    row.querySelector('[data-label="sputum"]').textContent = data.data.sputumCondition;
                    alert('Berhasil diupdate!');
                }
                modal.style.display = 'none';
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(err => alert('Terjadi kesalahan.'));
    });
    }

    // --- LOGIKA UNTUK DELETE ---
    document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const predictionId = this.dataset.id;
            if (confirm('Apakah Anda yakin ingin menghapus catatan prediksi ini secara permanen?')) {
                fetch('/api/prediction/' + predictionId, {
                    method: 'DELETE',
                    headers: { 'csrf-token': csrfToken }
                })
                .then(res => res.json())
                .then(data => {
                    if (data.message.includes('dihapus')) {
                        document.getElementById('pred-row-' + predictionId).remove();
                        alert('Catatan prediksi berhasil dihapus!');
                    } else {
                        alert('Error: ' + data.message);
                    }
                })
                .catch(err => alert('Terjadi kesalahan.'));
            }
        });
    });

    // Logika untuk menutup modal
    closeModalElements.forEach(el => el.onclick = () => modal.style.display = 'none');
    window.onclick = event => {
        if (event.target == modal) {
            modal.style.display = 'none';
        }
    };
});
</script>

<%- include('../../includes/tbcare/end.ejs') %>
