<%- include('../../includes/head.ejs') %>
<style>
    /* Style sederhana untuk modal, bisa disesuaikan */
    .modal {
        display: none; position: fixed; z-index: 1050; left: 0; top: 0;
        width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4);
    }
    .modal-content {
        background-color: #fefefe; margin: 10% auto; padding: 20px;
        border: 1px solid #888; width: 80%; max-width: 600px; border-radius: 8px;
    }
    .close-button { color: #aaa; float: right; font-size: 28px; font-weight: bold; }
    .close-button:hover, .close-button:focus { color: black; text-decoration: none; cursor: pointer; }
</style>
</head>
<body>
<div class="wrapper">
    <%- include('../../includes/navigations-tbcare.ejs') %>
    <div id="content-page" class="content-page">
        <%- include('../../includes/top-navbar.ejs') %>
        <div class="container-fluid">
            <div class="row">
                <div class="col-sm-12">
                    <div class="iq-card">
                        <div class="iq-card-header d-flex justify-content-between">
                            <div class="iq-header-title">
                                <h4 class="card-title">History for: <%= patient.fullName.first %> <%= patient.fullName.last %></h4>
                                <p>Participant ID: <%= patient.tbcareProfile ? patient.tbcareProfile.participantId : 'N/A' %></p>
                            </div>
                            <a href="/tbcare/patient-history" class="btn btn-secondary">Back to Patient List</a>
                        </div>
                        <div class="iq-card-body">
                            <div class="table-responsive">
                                <table class="table table-striped table-bordered">
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Result</th>
                                            <th>Sputum</th>
                                            <th>Segments (TB/Total)</th>
                                            <th>Predicted By</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <% if (predictions.length > 0) { %>
                                            <% predictions.forEach(pred => { %>
                                                <tr id="pred-row-<%= pred._id %>">
                                                    <td data-label="date"><%= new Date(pred.createdAt).toLocaleString() %></td>
                                                    <td data-label="result"><%= pred.result %></td>
                                                    <td data-label="sputum"><%= pred.sputumCondition %></td>
                                                    <td data-label="segments"><%= pred.tbSegmentCount %> / <%= pred.totalCoughSegments %></td>
                                                    <td data-label="doctor">Dr. <%= pred.predictedBy ? pred.predictedBy.userName : 'N/A' %></td>
                                                    <td>
                                                        <button class="btn btn-sm btn-info edit-btn" data-id="<%= pred._id %>" data-sputum="<%= pred.sputumCondition %>">Edit</button>
                                                        <button class="btn btn-sm btn-danger delete-btn" data-id="<%= pred._id %>">Delete</button>
                                                    </td>
                                                </tr>
                                            <% }) %>
                                        <% } else { %>
                                            <tr>
                                                <td colspan="6" class="text-center text-muted">No prediction history found.</td>
                                            </tr>
                                        <% } %>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <%- include('../../includes/footer.ejs') %>
    </div>
</div>

<div id="editModal" class="modal">
    <div class="modal-content">
        <span class="close-button">&times;</span>
        <h3>Edit Prediction Record</h3>
        <hr>
        <form id="editForm">
            <input type="hidden" id="editPredictionId" name="predictionId">
            <div class="form-group">
                <label for="newParticipantId">Remap to another Patient (Optional):</label>
                <input type="text" class="form-control" id="newParticipantId" placeholder="Enter new Participant ID">
            </div>
            <div class="row">
                <div class="form-group col-md-6">
                    <label for="editSputumStatus">Sputum Condition:</label>
                    <select class="form-control" id="editSputumStatus" name="sputumStatus">
                        <option value="Sputum +">Sputum +</option>
                        <option value="Sputum -">Sputum -</option>
                    </select>
                </div>
                <div class="form-group col-md-6" id="editSputumLevelContainer">
                    <label for="editSputumLevel">Sputum+ Level:</label>
                    <select class="form-control" id="editSputumLevel" name="sputumLevel">
                        <option value="Low">Low</option>
                        <option value="Moderate">Moderate</option>
                        <option value="High">High</option>
                    </select>
                </div>
            </div>
            <hr>
            <button type="button" class="btn iq-bg-danger" id="closeModalBtn">Cancel</button>
            <button type="submit" class="btn btn-primary">Save Changes</button>
        </form>
    </div>
</div>

<%- include('../../includes/end.ejs') %>
    
<script>
document.addEventListener('DOMContentLoaded', function() {
    const csrfToken = "<%= csrfToken %>";
    const modal = document.getElementById('editModal');
    const closeModalElements = document.querySelectorAll('.close-button, #closeModalBtn');

    // --- LOGIKA UNTUK EDIT ---
    document.querySelectorAll('.edit-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const predictionId = this.dataset.id;
            const currentSputum = this.dataset.sputum;

            // Isi form modal dengan data saat ini
            document.getElementById('editPredictionId').value = predictionId;
            
            if (currentSputum.includes('Sputum +')) {
                document.getElementById('editSputumStatus').value = 'Sputum +';
                document.getElementById('editSputumLevelContainer').style.display = 'block';
                if (currentSputum.includes('Low')) document.getElementById('editSputumLevel').value = 'Low';
                else if (currentSputum.includes('Moderate')) document.getElementById('editSputumLevel').value = 'Moderate';
                else if (currentSputum.includes('High')) document.getElementById('editSputumLevel').value = 'High';
            } else {
                document.getElementById('editSputumStatus').value = 'Sputum -';
                document.getElementById('editSputumLevelContainer').style.display = 'none';
            }

            modal.style.display = 'block';
        });
    });

    document.getElementById('editSputumStatus').addEventListener('change', function() {
        document.getElementById('editSputumLevelContainer').style.display = this.value === 'Sputum +' ? 'block' : 'none';
    });
    
    document.getElementById('editForm').addEventListener('submit', function(event) {
        event.preventDefault();
        const predictionId = document.getElementById('editPredictionId').value;
        
        const bodyData = {
            sputumStatus: document.getElementById('editSputumStatus').value,
            sputumLevel: document.getElementById('editSputumLevel').value
        };

        const newParticipantId = document.getElementById('newParticipantId').value;
        if (newParticipantId.trim() !== '') {
            bodyData.newParticipantId = newParticipantId.trim();
        }

        fetch('/api/v2/prediction/' + predictionId, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'csrf-token': csrfToken
            },
            body: JSON.stringify(bodyData)
        })
        .then(res => res.json())
        .then(data => {
            if (data.message.includes('diperbarui')) {
                // Jika berhasil, update data di tabel
                const row = document.getElementById('pred-row-' + predictionId);
                if (newParticipantId) {
                    // Jika pasien dipindah, hapus baris dari view ini
                    row.remove();
                    alert('Update successful! Record has been moved to another patient.');
                } else {
                    // Jika hanya update sputum, perbarui teks di tabel
                    row.querySelector('[data-label="sputum"]').textContent = data.data.sputumCondition;
                    alert('Update successful!');
                }
                modal.style.display = 'none';
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(err => alert('An error occurred.'));
    });

    // --- LOGIKA UNTUK DELETE ---
    document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const predictionId = this.dataset.id;
            if (confirm('Are you sure you want to permanently delete this prediction record?')) {
                fetch('/api/v2/prediction/' + predictionId, {
                    method: 'DELETE',
                    headers: { 'csrf-token': csrfToken }
                })
                .then(res => res.json())
                .then(data => {
                    if (data.message.includes('dihapus')) {
                        document.getElementById('pred-row-' + predictionId).remove();
                        alert('Prediction record deleted successfully!');
                    } else {
                        alert('Error: ' + data.message);
                    }
                })
                .catch(err => alert('An error occurred.'));
            }
        });
    });

    // Logika untuk menutup modal
    closeModalElements.forEach(el => el.onclick = () => modal.style.display = 'none');
    window.onclick = event => {
        if (event.target == modal) {
            modal.style.display = 'none';
        }
    };
});
</script>
</body>
</html>