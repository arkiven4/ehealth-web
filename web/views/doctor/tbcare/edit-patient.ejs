<%- include('../../includes/head.ejs') %>
</head>
<body>
<div class="wrapper">
    <%- include('../../includes/navigations-tbcare.ejs') %>
    <div id="content-page" class="content-page">
        <%- include('../../includes/top-navbar.ejs') %>
        <div class="container-fluid">
            <div class="row">
                <div class="col-lg-12">
                    <div class="iq-card">
                        <div class="iq-card-header d-flex justify-content-between">
                            <div class="iq-header-title">
                                <h4 class="card-title">Edit Patient: <%= patient.fullName.first %> <%= patient.fullName.last %></h4>
                            </div>
                        </div>
                        <div class="iq-card-body">
                            <form action="/tbcare/edit-patient" method="POST">
                                <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                                <input type="hidden" name="patientId" value="<%= patient._id %>">

                                <h5 class="mb-3">Clinical Data</h5>
                                <div class="row">
                                    <div class="form-group col-md-4"><label>Age:</label><input type="number" class="form-control" name="age" required value="<%= patient.tbcareProfile.age %>"></div>
                                    <div class="form-group col-md-4">
                                        <label>Sex:</label>
                                        <select class="form-control" name="sex" required>
                                            <option value="Male" <%= patient.tbcareProfile.sex === 'Male' ? 'selected' : '' %>>Male</option>
                                            <option value="Female" <%= patient.tbcareProfile.sex === 'Female' ? 'selected' : '' %>>Female</option>
                                        </select>
                                    </div>
                                    <div class="form-group col-md-4"><label>Height (cm):</label><input type="number" step="0.1" class="form-control" id="height" name="height" value="<%= patient.tbcareProfile.height %>"></div>
                                    <div class="form-group col-md-4"><label>Weight (Kg):</label><input type="number" step="0.1" class="form-control" id="weight" name="weight" value="<%= patient.tbcareProfile.weight %>"></div>
                                    <div class="form-group col-md-4"><label>BMI:</label><input type="text" class="form-control" id="bmi" name="bmi" readonly value="<%= patient.tbcareProfile.bmi %>"></div>
                                    <div class="form-group col-md-4"><label>Weight Status:</label><input type="text" class="form-control" id="weightStatus" name="weightStatus" readonly value="<%= patient.tbcareProfile.weightStatus %>"></div>
                                </div>
                                <hr>

                                <h5 class="mb-3">Symptoms</h5>
                                <div class="row">
                                     <div class="form-group col-md-4">
                                        <label>Productive Cough:</label>
                                        <select class="form-control" id="isCoughProductive" name="isCoughProductive">
                                            <option value="No" <%= patient.tbcareProfile.isCoughProductive === 'No' ? 'selected' : '' %>>No</option>
                                            <option value="Yes" <%= patient.tbcareProfile.isCoughProductive === 'Yes' ? 'selected' : '' %>>Yes</option>
                                        </select>
                                    </div>
                                    </div>
                                <hr>

                                <h5 class="mb-3">Patient Identity & Account</h5>
                                 <div class="row">
                                    <div class="form-group col-md-6"><label>First Name:</label><input type="text" class="form-control" name="fname" required value="<%= patient.fullName.first %>"></div>
                                    <div class="form-group col-md-6"><label>Last Name:</label><input type="text" class="form-control" name="lname" required value="<%= patient.fullName.last %>"></div>
                                    <div class="form-group col-md-6"><label>Email:</label><input type="email" class="form-control" name="email" required value="<%= patient.email %>"></div>
                                    <div class="form-group col-md-6"><label>Username:</label><input type="text" class="form-control" name="uname" required value="<%= patient.userName %>"></div>
                                    <div class="form-group col-md-6"><label>New Password (optional):</label><input type="password" class="form-control" name="pass"></div>
                                    <div class="form-group col-md-6"><label>Repeat New Password:</label><input type="password" class="form-control" name="rpass"></div>
                                </div>
                                <hr>

                                <a href="/tbcare/patient-history" class="btn iq-bg-danger">Cancel</a>
                                <button type="submit" class="btn btn-primary">Update Patient</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <%- include('../../includes/footer.ejs') %>
    </div>
</div>
<%- include('../../includes/end.ejs') %>
    <script>
      document.addEventListener('DOMContentLoaded', function() {
          // BMI Calculator
          const heightInput = document.getElementById('height');
          const weightInput = document.getElementById('weight');
          const bmiInput = document.getElementById('bmi');
          const weightStatusInput = document.getElementById('weightStatus');

          function calculateBmi() {
              const height = parseFloat(heightInput.value);
              const weight = parseFloat(weightInput.value);

              if (height > 0 && weight > 0) {
                  const heightInMeters = height / 100;
                  const bmi = weight / (heightInMeters * heightInMeters);
                  bmiInput.value = bmi.toFixed(2);

                  // Determine weight status
                  if (bmi < 18.5) {
                      weightStatusInput.value = 'Underweight';
                  } else if (bmi >= 18.5 && bmi < 24.9) {
                      weightStatusInput.value = 'Normal';
                  } else if (bmi >= 25 && bmi < 29.9) {
                      weightStatusInput.value = 'Overweight';
                  } else {
                      weightStatusInput.value = 'Obese';
                  }
              } else {
                  bmiInput.value = '';
                  weightStatusInput.value = '';
              }
          }
          heightInput.addEventListener('input', calculateBmi);
          weightInput.addEventListener('input', calculateBmi);

          // Conditional Cough Duration
          const isCoughProductiveSelect = document.getElementById('isCoughProductive');
          const coughDurationContainer = document.getElementById('coughDurationContainer');
          isCoughProductiveSelect.addEventListener('change', function() {
              coughDurationContainer.style.display = this.value === 'Yes' ? 'block' : 'none';
          });

          // Conditional Weight Loss Amount
          const hasWeightLossSelect = document.getElementById('hasWeightLoss');
          const weightLossAmountContainer = document.getElementById('weightLossAmountContainer');
          hasWeightLossSelect.addEventListener('change', function() {
              weightLossAmountContainer.style.display = this.value === 'Yes' ? 'block' : 'none';
          });

          // Conditional Tobacco Details
          const tobaccoUseSelect = document.getElementById('tobaccoUse');
          const tobaccoDetailsContainer = document.getElementById('tobaccoDetailsContainer');
          const cigarettesPerDayContainer = document.getElementById('cigarettesPerDayContainer');
          const smokingSinceContainer = document.getElementById('smokingSinceContainer');
          const stoppedSmokingContainer = document.getElementById('stoppedSmokingContainer');
          
          tobaccoUseSelect.addEventListener('change', function() {
              const value = this.value;
              if (value === 'current' || value === 'stopped') {
                  tobaccoDetailsContainer.style.display = 'flex'; // Use flex for row display
                  cigarettesPerDayContainer.style.display = value === 'current' ? 'block' : 'none';
                  smokingSinceContainer.style.display = value === 'current' ? 'block' : 'none';
                  stoppedSmokingContainer.style.display = value === 'stopped' ? 'block' : 'none';
              } else {
                  tobaccoDetailsContainer.style.display = 'none';
              }
          });
      });
   </script>
</body>
</html>