<% var useTbcareTheme = true; %>
<%- include('../../includes/head.ejs') %>
</head>
<body>
   <div class="wrapper">
      <%- include('../../includes/navigations-tbcare.ejs') %>
      <div id="content-page" class="content-page">
         <%- include('../../includes/top-navbar.ejs') %>
         <div class="container-fluid">
            <div class="row">
               <div class="col-lg-12">
                  <div class="iq-card">
                     <div class="iq-card-header d-flex justify-content-between">
                        <div class="iq-header-title">
                           <h4 class="card-title">Edit Patient: <%= patient.fullName.first %> <%= patient.fullName.last %></h4>
                        </div>
                     </div>
                     <div class="iq-card-body">
                        <%# Definisikan variabel tbProfile untuk kemudahan dan keamanan %>
                        <% const tbProfile = patient.tbcareProfile || {}; %>

                        <form action="/tbcare/edit-patient" method="POST">
                           <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                           <input type="hidden" name="patientId" value="<%= patient._id %>">
                           
                           <h5 class="mb-3">Patient Identity & Account</h5>
                           <div class="row">
                              <div class="form-group col-md-6"><label>First Name:</label><input type="text" class="form-control" name="fname" required value="<%= patient.fullName.first %>"></div>
                              <div class="form-group col-md-6"><label>Last Name:</label><input type="text" class="form-control" name="lname" value="<%= patient.fullName.last || '' %>"></div>
                              <div class="form-group col-md-6"><label>Email:</label><input type="email" class="form-control" name="email" required value="<%= patient.email %>"></div>
                              <!-- nik -->
                              <div class="form-group col-md-6"><label>NIK:</label><input type="number" class="form-control" name="nik" required value="<%= tbProfile.nik %>"></div>
                              <div class="form-group col-md-6"><label>Username:</label><input type="text" class="form-control" name="uname" required value="<%= patient.userName %>"></div>
                              <div class="form-group col-md-6"><label>New Password (optional):</label><input type="password" class="form-control" name="pass" placeholder="Leave blank to keep current password"></div>
                              <div class="form-group col-md-6"><label>Repeat New Password:</label><input type="password" class="form-control" name="rpass"></div>
                           </div>
                           <hr>
                           
                           <h5 class="mb-3">Patient Location</h5>
                           <div class="row">
                               <div class="form-group col-md-4">
                                   <label for="province-select">Provinsi:</label>
                                   <select class="form-control" id="province-select" name="province" required>
                                       <option value="">-- Pilih Provinsi --</option>
                                       <% provinces.forEach(province => { %>
                                           <option value="<%= province %>" <%= (tbProfile.province === province) ? 'selected' : '' %>><%= province %></option>
                                       <% }); %>
                                   </select>
                               </div>
                               <div class="form-group col-md-4" id="city-container" style="display: none;">
                                   <label for="city-select">Kota/Kabupaten:</label>
                                   <select class="form-control" id="city-select" name="city">
                                       <option value="">-- Pilih Kota/Kabupaten --</option>
                                       <option value="Surabaya" <%= (tbProfile.city === 'Surabaya') ? 'selected' : '' %>>Surabaya</option>
                                   </select>
                               </div>
                               <div class="form-group col-md-4" id="district-container" style="display: none;">
                                   <label for="district-select">Kecamatan:</label>
                                   <select class="form-control" id="district-select" name="district">
                                       <option value="">-- Pilih Kecamatan --</option>
                                        <% surabayaDistricts.forEach(district => { %>
                                           <option value="<%= district %>" <%= (tbProfile.district === district) ? 'selected' : '' %>><%= district %></option>
                                       <% }); %>
                                   </select>
                               </div>
                           </div>
                           <hr>

                           <h5 class="mb-3">Clinical Data</h5>
                           <div class="row align-items-end">
                              <div class="form-group col-md-4">
                                  <label for="dateOfBirth">Tanggal Lahir:</label>
                                  <input type="date" class="form-control" id="dateOfBirth" name="dateOfBirth" required value="<%= tbProfile.dateOfBirth ? tbProfile.dateOfBirth.toISOString().split('T')[0] : '' %>">
                              </div>
                              <div class="form-group col-md-2">
                                  <label>Umur:</label>
                                  <input type="text" class="form-control" id="age-display" readonly placeholder="(auto)">
                              </div>
                              <div class="form-group col-md-2"><label>Sex:</label>
                                <select class="form-control" name="sex" required>
                                  <option value="Male" <%= tbProfile.sex === 'Male' ? 'selected' : '' %>>Male</option>
                                  <option value="Female" <%= tbProfile.sex === 'Female' ? 'selected' : '' %>>Female</option>
                                </select>
                              </div>
                              <div class="form-group col-md-4"><label>Height (cm):</label><input type="number" step="0.1" class="form-control" id="height" name="height" value="<%= tbProfile.height || '' %>"></div>
                              <div class="form-group col-md-4"><label>Weight (Kg):</label><input type="number" step="0.1" class="form-control" id="weight" name="weight" value="<%= tbProfile.weight || '' %>"></div>
                              <div class="form-group col-md-4"><label>BMI:</label><input type="text" class="form-control" id="bmi" name="bmi" readonly value="<%= tbProfile.bmi || '' %>"></div>
                              <div class="form-group col-md-4"><label>Weight Status:</label><input type="text" class="form-control" id="weightStatus" name="weightStatus" readonly value="<%= tbProfile.weightStatus || '' %>"></div>
                           </div>
                           <hr>

                           <h5 class="mb-3">Symptoms</h5>
                           <div class="row">
                              <div class="form-group col-md-4"><label>Productive Cough:</label>
                                <select class="form-control" id="isCoughProductive" name="isCoughProductive">
                                  <option value="No" <%= tbProfile.isCoughProductive === 'No' ? 'selected' : '' %>>No</option>
                                  <option value="Yes" <%= tbProfile.isCoughProductive === 'Yes' ? 'selected' : '' %>>Yes</option>
                                </select>
                              </div>
                              <div class="form-group col-md-8" id="coughDurationContainer" style="display: none;"><label>Cough Duration (days):</label><input type="number" class="form-control" name="coughDurationDays" value="<%= tbProfile.coughDurationDays || '' %>"></div>
                              <div class="form-group col-md-4"><label>Weight Loss:</label>
                                <select class="form-control" id="hasWeightLoss" name="hasWeightLoss">
                                  <option value="No" <%= tbProfile.hasWeightLoss === 'No' ? 'selected' : '' %>>No</option>
                                  <option value="Yes" <%= tbProfile.hasWeightLoss === 'Yes' ? 'selected' : '' %>>Yes</option>
                                </select>
                              </div>
                              <div class="form-group col-md-8" id="weightLossAmountContainer" style="display: none;"><label>Weight Loss Amount (Kg):</label><input type="number" step="0.1" class="form-control" name="weightLossAmountKg" value="<%= tbProfile.weightLossAmountKg || '' %>"></div>
                              <div class="form-group col-md-3"><label>Hemoptysis:</label>
                                <select class="form-control" name="hasHemoptysis">
                                  <option value="No" <%= tbProfile.hasHemoptysis === 'No' ? 'selected' : '' %>>No</option>
                                  <option value="Yes" <%= tbProfile.hasHemoptysis === 'Yes' ? 'selected' : '' %>>Yes</option>
                                </select>
                              </div>
                              <div class="form-group col-md-3"><label>Chest Pain:</label>
                                <select class="form-control" name="hasChestPain">
                                  <option value="No" <%= tbProfile.hasChestPain === 'No' ? 'selected' : '' %>>No</option>
                                  <option value="Yes" <%= tbProfile.hasChestPain === 'Yes' ? 'selected' : '' %>>Yes</option>
                                </select>
                              </div>
                              <div class="form-group col-md-3"><label>Short Breath:</label>
                                <select class="form-control" name="hasShortBreath">
                                  <option value="No" <%= tbProfile.hasShortBreath === 'No' ? 'selected' : '' %>>No</option>
                                  <option value="Yes" <%= tbProfile.hasShortBreath === 'Yes' ? 'selected' : '' %>>Yes</option>
                                </select>
                              </div>
                              <div class="form-group col-md-3"><label>Fever:</label>
                                <select class="form-control" name="hasFever">
                                  <option value="No" <%= tbProfile.hasFever === 'No' ? 'selected' : '' %>>No</option>
                                  <option value="Yes" <%= tbProfile.hasFever === 'Yes' ? 'selected' : '' %>>Yes</option>
                                </select>
                              </div>
                              <div class="form-group col-md-3"><label>Night Sweats:</label>
                                <select class="form-control" name="hasNightSweats">
                                  <option value="No" <%= tbProfile.hasNightSweats === 'No' ? 'selected' : '' %>>No</option>
                                  <option value="Yes" <%= tbProfile.hasNightSweats === 'Yes' ? 'selected' : '' %>>Yes</option>
                                </select>
                              </div>
                           </div>
                           <hr>
                           
                           <h5 class="mb-3">History</h5>
                           <div class="row">
                              <div class="form-group col-md-4"><label>Prior TB:</label>
                                <select class="form-control" name="hadPriorTB">
                                  <option value="No" <%= tbProfile.hadPriorTB === 'No' ? 'selected' : '' %>>No</option>
                                  <option value="Yes" <%= tbProfile.hadPriorTB === 'Yes' ? 'selected' : '' %>>Yes</option>
                                </select>
                              </div>
                              <div class="form-group col-md-8"><label>Tobacco Use:</label>
                                <select class="form-control" id="tobaccoUse" name="tobaccoUse">
                                  <option value="never" <%= tbProfile.tobaccoUse === 'never' ? 'selected' : '' %>>Never</option>
                                  <option value="current" <%= tbProfile.tobaccoUse === 'current' ? 'selected' : '' %>>Current</option>
                                  <option value="stopped" <%= tbProfile.tobaccoUse === 'stopped' ? 'selected' : '' %>>Stopped</option>
                                  <option value="not disclosed" <%= tbProfile.tobaccoUse === 'not disclosed' ? 'selected' : '' %>>Not Disclosed</option>
                                </select>
                              </div>
                           </div>
                           <div class="row" id="tobaccoDetailsContainer" style="display: none;">
                                <div class="form-group col-md-4" id="cigarettesPerDayContainer"><label>Cigarettes/Day:</label><input type="number" name="cigarettesPerDay" class="form-control" value="<%= tbProfile.cigarettesPerDay || '' %>"></div>
                                <div class="form-group col-md-4" id="smokingSinceContainer"><label>Smoking Since (months):</label><input type="number" name="smokingSinceMonths" class="form-control" value="<%= tbProfile.smokingSinceMonths || '' %>"></div>
                                <div class="form-group col-md-4" id="stoppedSmokingContainer"><label>Stopped Smoking Since (months):</label><input type="number" name="stoppedSmokingMonths" class="form-control" value="<%= tbProfile.stoppedSmokingMonths || '' %>"></div>
                           </div>
                           <hr>

                           <h5 class="mb-3">Comorbidity History</h5>
                           <div class="form-group">
                                <% const comorbidities = tbProfile.comorbidities || []; %>
                                <div class="custom-control custom-checkbox"><input type="checkbox" class="custom-control-input" id="cb-diabet" name="comorbidities" value="Diabet" <%= comorbidities.includes('Diabet') ? 'checked' : '' %>><label class="custom-control-label" for="cb-diabet">Diabet</label></div>
                                <div class="custom-control custom-checkbox"><input type="checkbox" class="custom-control-input" id="cb-hipertensi" name="comorbidities" value="Hipertensi" <%= comorbidities.includes('Hipertensi') ? 'checked' : '' %>><label class="custom-control-label" for="cb-hipertensi">Hipertensi</label></div>
                                <div class="custom-control custom-checkbox"><input type="checkbox" class="custom-control-input" id="cb-kencingmanis" name="comorbidities" value="Kencing Manis" <%= comorbidities.includes('Kencing Manis') ? 'checked' : '' %>><label class="custom-control-label" for="cb-kencingmanis">Kencing Manis</label></div>
                                <div class="custom-control custom-checkbox"><input type="checkbox" class="custom-control-input" id="cb-gagalginjal" name="comorbidities" value="Gagal Ginjal" <%= comorbidities.includes('Gagal Ginjal') ? 'checked' : '' %>><label class="custom-control-label" for="cb-gagalginjal">Gagal Ginjal</label></div>
                                <div class="custom-control custom-checkbox"><input type="checkbox" class="custom-control-input" id="cb-rematik" name="comorbidities" value="Rematik" <%= comorbidities.includes('Rematik') ? 'checked' : '' %>><label class="custom-control-label" for="cb-rematik">Rematik</label></div>
                                <div class="custom-control custom-checkbox"><input type="checkbox" class="custom-control-input" id="cb-stroke" name="comorbidities" value="Stroke" <%= comorbidities.includes('Stroke') ? 'checked' : '' %>><label class="custom-control-label" for="cb-stroke">Stroke</label></div>
                                <div class="custom-control custom-checkbox"><input type="checkbox" class="custom-control-input" id="cb-gerd" name="comorbidities" value="GERD" <%= comorbidities.includes('GERD') ? 'checked' : '' %>><label class="custom-control-label" for="cb-gerd">GERD</label></div>
                                <div class="form-group mt-2"><label>Other:</label><input type="text" class="form-control" name="comorbiditiesOther" placeholder="Sebutkan penyakit lain..." value="<%= tbProfile.comorbiditiesOther || '' %>"></div>
                           </div>
                           <hr>

                           <a href="/tbcare/patient-history" class="btn iq-bg-danger">Cancel</a>
                           <button type="submit" class="btn btn-primary">Update Patient</button>
                        </form>
                     </div>
                  </div>
               </div>
            </div>
         </div>
         <%- include('../../includes/footer.ejs') %>
      </div>
   </div>
   <%- include('../../includes/end.ejs') %>

   <script>
      document.addEventListener('DOMContentLoaded', function() {
          // --- Helper Functions ---
          function setupConditionalDisplay(selectId, containerId, triggerValue) {
              const selectElement = document.getElementById(selectId);
              const container = document.getElementById(containerId);
              if (!selectElement || !container) return;
              function toggle() { container.style.display = selectElement.value === triggerValue ? 'block' : 'none'; }
              selectElement.addEventListener('change', toggle);
              toggle();
          }

          // --- Initializations ---
          // BMI Calculator
          const heightInput = document.getElementById('height');
          const weightInput = document.getElementById('weight');
          const bmiInput = document.getElementById('bmi');
          const weightStatusInput = document.getElementById('weightStatus');
          function calculateBmi() {
              const height = parseFloat(heightInput.value);
              const weight = parseFloat(weightInput.value);
              if (height > 0 && weight > 0) {
                  const bmi = weight / ((height / 100) ** 2);
                  bmiInput.value = bmi.toFixed(2);
                  if (bmi < 18.5) weightStatusInput.value = 'Underweight';
                  else if (bmi < 24.9) weightStatusInput.value = 'Normal';
                  else if (bmi < 29.9) weightStatusInput.value = 'Overweight';
                  else weightStatusInput.value = 'Obese';
              } else {
                  bmiInput.value = '';
                  weightStatusInput.value = '';
              }
          }
          if(heightInput && weightInput) {
            heightInput.addEventListener('input', calculateBmi);
            weightInput.addEventListener('input', calculateBmi);
            calculateBmi(); // Initial call
          }

          // Date of Birth to Age
          const dobInput = document.getElementById('dateOfBirth');
          const ageDisplay = document.getElementById('age-display');
          function displayAge() {
              if (!dobInput.value) { ageDisplay.value = ''; return; }
              const birthDate = new Date(dobInput.value);
              const today = new Date();
              let age = today.getFullYear() - birthDate.getFullYear();
              const m = today.getMonth() - birthDate.getMonth();
              if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) age--;
              ageDisplay.value = age >= 0 ? age + " tahun" : "";
          }
          dobInput.addEventListener('input', displayAge);
          displayAge();

          // Conditional Symptom Fields
          setupConditionalDisplay('isCoughProductive', 'coughDurationContainer', 'Yes');
          setupConditionalDisplay('hasWeightLoss', 'weightLossAmountContainer', 'Yes');

          // Conditional Tobacco Fields
          const tobaccoUseSelect = document.getElementById('tobaccoUse');
          function toggleTobacco() {
              const value = tobaccoUseSelect.value;
              document.getElementById('tobaccoDetailsContainer').style.display = (value === 'current' || value === 'stopped') ? 'flex' : 'none';
              document.getElementById('cigarettesPerDayContainer').style.display = value === 'current' ? 'block' : 'none';
              document.getElementById('smokingSinceContainer').style.display = value === 'current' ? 'block' : 'none';
              document.getElementById('stoppedSmokingContainer').style.display = value === 'stopped' ? 'block' : 'none';
          }
          tobaccoUseSelect.addEventListener('change', toggleTobacco);
          toggleTobacco();

          // Dynamic Location Dropdowns
          const provinceSelect = document.getElementById('province-select');
          const cityContainer = document.getElementById('city-container');
          const citySelect = document.getElementById('city-select');
          const districtContainer = document.getElementById('district-container');
          function toggleLocationDropdowns() {
              const selectedProvince = provinceSelect.value;
              const selectedCity = citySelect.value;
              cityContainer.style.display = selectedProvince === 'JAWA TIMUR' ? 'block' : 'none';
              if (selectedProvince !== 'JAWA TIMUR') citySelect.value = '';
              districtContainer.style.display = (selectedProvince === 'JAWA TIMUR' && selectedCity === 'Surabaya') ? 'block' : 'none';
              if (selectedCity !== 'Surabaya') document.getElementById('district-select').value = '';
          }
          provinceSelect.addEventListener('change', toggleLocationDropdowns);
          citySelect.addEventListener('change', toggleLocationDropdowns);
          toggleLocationDropdowns();
      });
   </script>
</body>
</html>