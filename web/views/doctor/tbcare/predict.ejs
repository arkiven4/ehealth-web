<% var useTbcareTheme = true; %>
<%- include('../../includes/head.ejs') %>
<style>
    .file-selection-box { max-height: 400px; overflow-y: auto; border: 1px solid #e0e0e0; padding: 10px; border-radius: 5px; background-color: #f9f9f9; }
    .file-option { display: block; margin-bottom: 15px; }
    .file-option label { width: 100%; }
</style>
</head>
<body>
<div class="wrapper">
    <%- include('../../includes/navigations-tbcare.ejs') %>
    <div id="content-page" class="content-page">
        <%- include('../../includes/top-navbar.ejs') %>
        <div class="container-fluid">
            <div class="row">
                <div class="col-lg-12">
                    <div class="iq-card">
                        <div class="iq-card-header d-flex justify-content-between">
                            <div class="iq-header-title"><h4 class="card-title"><%= pageHeader %></h4></div>
                        </div>
                        <div class="iq-card-body">
                            <% if (errorMessage && errorMessage.length > 0) { %>
                                <div class="alert alert-danger" role="alert">
                                    <div class="iq-alert-text"><b>Error:</b> <%= errorMessage %></div>
                                </div>
                            <% } %>
                            <form action="/tbcare/predict" method="POST">
                                <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                                <div class="row">
                                    <div class="form-group col-md-12">
                                        <label>1. Select Patient:</label>
                                        <select class="form-control" name="patientId" id="patientSelect" required>
                                            <option value="">-- Choose a patient --</option>
                                            <% if(patients.length > 0) { %>
                                                <% patients.forEach(p => { %>
                                                    <option value="<%= p.tbcareProfile.nik %>" data-nik="<%= p.tbcareProfile.nik %>"><%= p.fullName.first %> <%= p.fullName.last %> (NIK: <%= p.tbcareProfile ? p.tbcareProfile.nik : 'N/A' %>)</option>
                                                <% }) %>
                                            <% } %>
                                        </select>
                                    </div>
                                    
                                    <div class="form-group col-md-6">
                                        <label>2. Sputum Condition:</label>
                                        <select class="form-control" name="sputumStatus" id="sputumStatus" required>
                                            <option value="">-- Select Status --</option>
                                            <option value="Sputum +">Sputum +</option>
                                            <option value="Sputum -">Sputum -</option>
                                        </select>
                                    </div>
                                    <div class="form-group col-md-6" id="sputumLevelContainer" style="display: none;">
                                        <label>Sputum+ Level:</label>
                                        <select class="form-control" name="sputumLevel">
                                            <option value="Low">Low</option>
                                            <option value="Moderate">Moderate</option>
                                            <option value="High">High</option>
                                        </select>
                                    </div>

                                    <div class="form-group col-md-12">
                                        <label>3. Select Unprocessed Cough Recording:</label>
                                        <div id="loadingMessage" class="text-center text-muted mt-3" style="display: none;">
                                            <i class="fa fa-spinner fa-spin"></i> Loading cough recordings...
                                        </div>
                                        <div class="row mb-3" id="filterControls" style="display: none;">
                                            <div class="col-md-6"><input type="text" id="searchInput" class="form-control" placeholder="Search by filename..."></div>
                                            <div class="col-md-6"><input type="date" id="dateFilter" class="form-control"></div>
                                        </div>
                                        <div class="file-selection-box" id="fileList">
                                            <p class="text-center text-muted mt-3">Please select a patient first to view cough recordings.</p>
                                        </div>
                                    </div>
                                </div>
                                <hr>
                                <a href="/sub_1/doctor" class="btn iq-bg-danger">Cancel</a>
                                <button type="submit" class="btn btn-primary">Start Prediction</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <%- include('../../includes/footer.ejs') %>
    </div>
</div>
<%- include('../../includes/end.ejs') %>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const sputumStatusSelect = document.getElementById('sputumStatus');
        const sputumLevelContainer = document.getElementById('sputumLevelContainer');
        sputumStatusSelect.addEventListener('change', function() {
            sputumLevelContainer.style.display = this.value === 'Sputum +' ? 'block' : 'none';
        });

        const searchInput = document.getElementById('searchInput');
        const dateFilter = document.getElementById('dateFilter');
        const allFiles = document.querySelectorAll('.file-option');

        function filterFiles() {
            const searchTerm = searchInput.value.toLowerCase();
            const selectedDate = dateFilter.value;

            allFiles.forEach(fileEl => {
                const fileName = fileEl.dataset.filename;
                const fileDate = fileEl.dataset.date;

                const matchesSearch = fileName.includes(searchTerm);
                const matchesDate = !selectedDate || fileDate === selectedDate;

                if (matchesSearch && matchesDate) {
                    fileEl.style.display = 'block';
                } else {
                    fileEl.style.display = 'none';
                }
            });
        }
        searchInput.addEventListener('input', filterFiles);
        dateFilter.addEventListener('change', filterFiles);

        const patientSelect = document.getElementById('patientSelect');
        patientSelect.addEventListener('change', async function() {
            const selectedOption = this.options[this.selectedIndex];
            //const nik = selectedOption.getAttribute('data-nik');
            // DEBUG
            const nik = '5171045111030002'
            
            if (!nik) {
                fileList.innerHTML = '<p class="text-center text-muted mt-3">Please select a patient first to view cough recordings.</p>';
                filterControls.style.display = 'none';
                return;
            }

            loadingMessage.style.display = 'block';
            fileList.innerHTML = '';
            filterControls.style.display = 'none';

            try {
                const response = await fetch(`/tbcare/getPredict_filteredWav?nik=${nik}`);
                const data = await response.json();
                console.log(data)
                
                loadingMessage.style.display = 'none';
                
                if (data.success && data.data && data.data.length > 0) {
                    displayCoughRecordings(data.data);
                    filterControls.style.display = 'flex';
                } else {
                    fileList.innerHTML = '<p class="text-center text-muted mt-3">No cough recordings found for this patient.</p>';
                }
            } catch (error) {
                console.error('Error fetching cough recordings:', error);
                loadingMessage.style.display = 'none';
                fileList.innerHTML = '<p class="text-center text-danger mt-3">Error loading cough recordings. Please try again.</p>';
            }
        });

        function displayCoughRecordings(recordings) {
            let html = '';
            recordings.forEach((record, index) => {
                const jsonData = record.json_data || {};
                const fileName = jsonData.file_audio || 'unknown.wav';
                const patientName = jsonData.nama || 'Unknown';
                const coughType = record.cough_type || 'Unknown';
                const recordTime = new Date(record.time);
                const displayDate = recordTime.toLocaleDateString('en-GB', { 
                    day: 'numeric', 
                    month: 'long', 
                    year: 'numeric' 
                });
                
                const displayTime = recordTime.toLocaleTimeString('en-GB', { 
                    hour: '2-digit', 
                    minute: '2-digit',
                    hour12: false
                }) + ' WIB';
                
                const audioPath = `/uploads/batuk_tbprimer/${fileName}`;
                
                html += `
                    <div class="custom-control custom-radio file-option" data-filename="${fileName.toLowerCase()}" data-date="${displayDate}">
                        <input type="radio" id="file_${index}" name="coughFilePath" value="${audioPath}" class="custom-control-input" required>
                        <label class="custom-control-label" for="file_${index}">
                            üìÖ ${displayDate} ‚è∞ ${displayTime}
                            <br>
                            <div class="mt-2">
                                <audio controls controlsList="nodownload" style="width: 100%;">
                                    <source src="${audioPath}" type="audio/wav">
                                    Your browser does not support the audio element.
                                </audio>
                            </div>
                        </label>
                    </div>
                `;
            });
            fileList.innerHTML = html;
            attachFilterListeners();
        }

        function attachFilterListeners() {
            const allFiles = document.querySelectorAll('.file-option');

            function filterFiles() {
                const searchTerm = searchInput.value.toLowerCase();
                const selectedDate = dateFilter.value;

                allFiles.forEach(fileEl => {
                    const fileName = fileEl.dataset.filename;
                    const fileDate = fileEl.dataset.date;

                    const matchesSearch = fileName.includes(searchTerm);
                    const matchesDate = !selectedDate || fileDate === selectedDate;

                    if (matchesSearch && matchesDate) {
                        fileEl.style.display = 'block';
                    } else {
                        fileEl.style.display = 'none';
                    }
                });
            }

            searchInput.removeEventListener('input', filterFiles);
            dateFilter.removeEventListener('change', filterFiles);
            searchInput.addEventListener('input', filterFiles);
            dateFilter.addEventListener('change', filterFiles);
        }
    });
</script>
</body>
</html>