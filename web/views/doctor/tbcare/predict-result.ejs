<% var useTbcareTheme = true; %>
<%- include('../../includes/head.ejs') %>
<style>
    .result-card {
        border-radius: 15px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        margin-bottom: 30px;
    }
    .result-header {
        background: linear-gradient(135deg, #667eea 0%, #24be90 100%);
        color: white;
        border-radius: 15px 15px 0 0;
        padding: 25px;
    }
    .stat-card {
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        border: none;
        box-shadow: 0 2px 15px rgba(0,0,0,0.08);
    }
    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 5px 25px rgba(0,0,0,0.15);
    }
    .stat-card .stat-icon {
        font-size: 2.5rem;
        opacity: 0.8;
        margin-bottom: 10px;
    }
    .stat-card h3 {
        font-size: 2.5rem;
        font-weight: bold;
        margin: 10px 0;
    }
    .stat-card p {
        margin: 0;
        opacity: 0.9;
        font-weight: 500;
    }
    .prediction-badge {
        font-size: 3rem;
        padding: 20px 50px;
        border-radius: 50px;
        font-weight: bold;
        display: inline-block;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }
    .prediction-tb {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        color: white;
    }
    .prediction-nontb {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        color: white;
    }
    .confidence-bar {
        height: 30px;
        border-radius: 15px;
        overflow: hidden;
        background: #e9ecef;
    }
    .audio-player-card {
        background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
        border-radius: 12px;
        padding: 20px;
    }
    .segment-table {
        border-radius: 10px;
        overflow: hidden;
    }
    .segment-table thead {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }
    .chart-container {
        position: relative;
        height: 350px;
        margin-bottom: 30px;
    }
    .viz-card {
        border-radius: 15px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        margin-top: 20px;
    }
    .viz-card .iq-card-header {
        border-bottom: 2px solid #f0f0f0;
        padding: 20px 25px;
        background: linear-gradient(135deg, #667eea08 0%, #764ba208 100%);
    }
    .viz-card .iq-card-header h5 {
        font-size: 1.1rem;
        font-weight: 600;
        color: #333;
    }
    .viz-card .iq-card-body {
        padding: 25px;
    }
    .font-weight-500 {
        font-weight: 500;
    }
</style>
</head>
<body>
<div class="wrapper">
    <%- include('../../includes/navigations-tbcare.ejs') %>
    <div id="content-page" class="content-page">
        <%- include('../../includes/tbcare/top-navbar.ejs') %>
        <div class="container-fluid">
            <!-- Header Card -->
            <div class="row">
                <div class="col-lg-12">
                    <div class="result-card">
                        <div class="result-header">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h2 class="mb-0 text-white font-weight-bold">
                                        <i class="ri-file-chart-line"></i> <span data-i18n="result.title">Hasil Analisis Prediksi Tuberkulosis</span>
                                        <% if (typeof isHistoryView !== 'undefined' && isHistoryView) { %>
                                            <span class="badge badge-light ml-2" style="font-size: 0.5em; vertical-align: middle;">
                                                <i class="ri-history-line"></i> History
                                            </span>
                                        <% } %>
                                    </h2>
                                    <p class="mb-0 mt-2 text-white">
                                        <span data-i18n="result.subtitle">Analisis audio batuk menggunakan Machine Learning dengan YAMNet + LSTM</span>
                                        <% if (typeof predictionDate !== 'undefined' && predictionDate) { %>
                                            <br>
                                            <small><i class="ri-calendar-line"></i> Tanggal Prediksi: <%= new Date(predictionDate).toLocaleString('id-ID') %></small>
                                        <% } %>
                                    </p>
                                </div>
                                <% if (typeof predictionId !== 'undefined' && predictionId) { %>
                                <div>
                                    <% 
                                    const vStatus = (typeof validationStatus !== 'undefined') ? validationStatus : 'pending';
                                    const isPending = vStatus === 'pending';
                                    const isAccepted = vStatus === 'accepted';
                                    const isRejected = vStatus === 'rejected';
                                    %>
                                    
                                    <% if (isPending) { %>
                                        <button class="btn btn-success btn-lg mr-2 validation-action-btn" 
                                                data-id="<%= predictionId %>" 
                                                data-action="accepted"
                                                title="Terima Hasil Prediksi">
                                            <i class="ri-checkbox-circle-line"></i> Terima (Accept)
                                        </button>
                                        <button class="btn btn-danger btn-lg validation-action-btn" 
                                                data-id="<%= predictionId %>" 
                                                data-action="rejected"
                                                title="Tolak Hasil Prediksi">
                                            <i class="ri-close-circle-line"></i> Tolak (Reject)
                                        </button>
                                    <% } else if (isAccepted) { %>
                                        <span class="badge badge-success btn-lg mr-2" style="font-size: 1em;">
                                            <i class="ri-checkbox-circle-line"></i> DITERIMA
                                        </span>
                                        <button class="btn btn-warning btn-lg validation-action-btn" 
                                                data-id="<%= predictionId %>" 
                                                data-action="pending"
                                                title="Reset Status Validasi">
                                            <i class="ri-refresh-line"></i> Reset
                                        </button>
                                    <% } else if (isRejected) { %>
                                        <span class="badge badge-danger btn-lg mr-2" style="font-size: 1em;">
                                            <i class="ri-close-circle-line"></i> DITOLAK
                                        </span>
                                        <button class="btn btn-warning btn-lg validation-action-btn" 
                                                data-id="<%= predictionId %>" 
                                                data-action="pending"
                                                title="Reset Status Validasi">
                                            <i class="ri-refresh-line"></i> Reset
                                        </button>
                                    <% } %>
                                </div>
                                <% } %>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Patient Info & Audio Player -->
            <div class="row">
                <div class="col-lg-6">
                    <div class="iq-card stat-card">
                        <div class="iq-card-body">
                            <h5 class="mb-3"><i class="ri-user-line"></i> Informasi Pasien</h5>
                            <table class="table table-borderless mb-0">
                                <tr>
                                    <td width="40%" class="font-weight-bold">Nama:</td>
                                    <td>
                                        <% if (patient.fullName && patient.fullName.first) { %>
                                            <%= patient.fullName.first %> <%= patient.fullName.last %>
                                        <% } else { %>
                                            <%= patient.userName || 'Nama tidak tersedia' %>
                                        <% } %>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="font-weight-bold">Kondisi Sputum:</td>
                                    <td><span class="badge badge-info"><%= sputumCondition %></span></td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="col-lg-6">
                    <div class="iq-card audio-player-card">
                        <div class="iq-card-body">
                            <h5 class="mb-3"><i class="ri-music-line"></i> Audio Sample</h5>
                            <p class="mb-2"><strong>File:</strong> <code><%= audioFile.split('/').pop() %></code></p>
                            <audio controls style="width: 100%; border-radius: 10px;">
                                <source src="<%= audioFile %>" type="audio/wav">
                                Browser Anda tidak mendukung elemen audio.
                            </audio>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main Prediction Result -->
            <div class="row">
                <div class="col-lg-12">
                    <div class="iq-card result-card">
                        <div class="iq-card-body text-center py-5">
                            <h3 class="mb-4" data-i18n="result.finalTitle">Hasil Akhir Prediksi</h3>
                            <div class="mb-4">
                                <span class="prediction-badge <%= prediction === 'TB' ? 'prediction-tb' : 'prediction-nontb' %>">
                                    <% if (prediction === 'TB') { %>
                                        <i class="ri-alert-line"></i> TB TERDETEKSI
                                    <% } else { %>
                                        <i class="ri-checkbox-circle-line"></i> NON-TB
                                    <% } %>
                                </span>
                            </div>
                            <h4 class="mb-3">Tingkat Keyakinan: 
                                <span class="badge badge-primary" style="font-size: 1.5rem; padding: 10px 25px;">
                                    <%= confidencePercentage %>%
                                </span>
                            </h4>
                            <p class="text-muted mb-0">
                                <i class="ri-information-line"></i> 
                                Berdasarkan analisis <%= validCoughSegments %> segmen batuk valid dengan rata-rata probabilitas TB: <%= (avgTbProbability * 100).toFixed(2) %>%
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Statistics Cards -->
            <div class="row">
                <div class="col-lg-3 col-md-6">
                    <div class="stat-card" style="background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);">
                        <div class="text-center">
                            <div class="stat-icon">üìä</div>
                            <h3 class="text-primary"><%= totalSegments %></h3>
                            <p class="text-muted">Total Segmen Audio</p>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6">
                    <div class="stat-card" style="background: linear-gradient(135deg, #4facfe15 0%, #00f2fe15 100%);">
                        <div class="text-center">
                            <div class="stat-icon">‚úÖ</div>
                            <h3 class="text-info"><%= validCoughSegments %></h3>
                            <p class="text-muted">Segmen Batuk Valid</p>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6">
                    <div class="stat-card" style="background: linear-gradient(135deg, #f093fb15 0%, #f5576c15 100%);">
                        <div class="text-center">
                            <div class="stat-icon">‚ö†Ô∏è</div>
                            <h3 class="text-danger"><%= tbSegments %></h3>
                            <p class="text-muted">Segmen TB</p>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6">
                    <div class="stat-card" style="background: linear-gradient(135deg, #43e97b15 0%, #38f9d715 100%);">
                        <div class="text-center">
                            <div class="stat-icon">‚úîÔ∏è</div>
                            <h3 class="text-success"><%= nonTbSegments %></h3>
                            <p class="text-muted">Segmen Non-TB</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Pie Charts: Overall & Per-Segment Confidence -->
            <div class="row">
                <div class="col-lg-6">
                    <div class="iq-card viz-card">
                        <div class="iq-card-header d-flex justify-content-between align-items-center">
                            <h5 class="card-title mb-0"><i class="ri-pie-chart-line"></i> Distribusi Segmen</h5>
                        </div>
                        <div class="iq-card-body">
                            <div class="chart-container" style="height: 350px; position: relative;">
                                <canvas id="segmentDistributionChart"></canvas>
                            </div>
                            <div class="text-center mt-3">
                                <div class="d-inline-flex align-items-center mx-3">
                                    <span style="display:inline-block;width:15px;height:15px;background:#f5576c;border-radius:3px;margin-right:8px;"></span>
                                    <span class="font-weight-500">TB: <%= tbSegments %></span>
                                </div>
                                <div class="d-inline-flex align-items-center mx-3">
                                    <span style="display:inline-block;width:15px;height:15px;background:#00f2fe;border-radius:3px;margin-right:8px;"></span>
                                    <span class="font-weight-500">Non-TB: <%= nonTbSegments %></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-6">
                    <div class="iq-card viz-card">
                        <div class="iq-card-header d-flex justify-content-between align-items-center">
                            <h5 class="card-title mb-0"><i class="ri-donut-chart-line"></i> Confidence Level</h5>
                        </div>
                        <div class="iq-card-body">
                            <div class="text-center mb-4">
                                <h2 class="display-4 font-weight-bold text-primary"><%= confidencePercentage %>%</h2>
                                <p class="text-muted mb-0">Rata-rata Probabilitas TB</p>
                            </div>
                            <div class="confidence-bar mb-3" style="height: 40px;">
                                <div style="width: <%= confidencePercentage %>%; height: 100%; background: linear-gradient(90deg, #667eea 0%, <%= prediction === 'TB' ? '#f5576c' : '#00f2fe' %> 100%); border-radius: 15px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; transition: width 1s ease;">
                                    <%= confidencePercentage %>%
                                </div>
                            </div>
                            <div class="row text-center mt-4">
                                <div class="col-6">
                                    <div class="p-3" style="background: #667eea15; border-radius: 10px;">
                                        <h4 class="font-weight-bold text-primary"><%= (avgTbProbability * 100).toFixed(2) %>%</h4>
                                        <small class="text-muted">Avg TB Probability</small>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="p-3" style="background: <%= prediction === 'TB' ? '#f5576c15' : '#00f2fe15' %>; border-radius: 10px;">
                                        <h4 class="font-weight-bold <%= prediction === 'TB' ? 'text-danger' : 'text-info' %>"><%= prediction %></h4>
                                        <small class="text-muted">Final Decision</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Per-Segment Details Table -->
            <% if (segmentDetails && segmentDetails.length > 0) { %>
                <div class="row">
                    <div class="col-lg-12">
                        <div class="iq-card viz-card">
                            <div class="iq-card-header">
                                <h5 class="card-title"><i class="ri-list-check-2"></i> Detail Analisis Per Segmen</h5>
                            </div>
                            <div class="iq-card-body">
                                <div class="table-responsive">
                                    <table class="table segment-table table-hover">
                                        <thead>
                                            <tr>
                                                <th class="text-center" width="8%">Segmen</th>
                                                <th class="text-center" width="12%">Status Batuk</th>
                                                <th width="22%">Cough Validation</th>
                                                <th width="22%">TB Probability</th>
                                                <th class="text-center" width="12%">Confidence</th>
                                                <th class="text-center" width="12%">Prediksi</th>
                                                <th class="text-center" width="12%">Chart</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <% segmentDetails.forEach(function(seg, idx) { %>
                                                <tr>
                                                    <td class="text-center">
                                                        <strong class="text-primary">#<%= seg.segment_id %></strong>
                                                    </td>
                                                    <td class="text-center">
                                                        <% if (seg.is_cough) { %>
                                                            <span class="badge badge-success">‚úì Cough</span>
                                                        <% } else { %>
                                                            <span class="badge badge-secondary">‚úó Non-Cough</span>
                                                        <% } %>
                                                    </td>
                                                    <td>
                                                        <div class="d-flex align-items-center">
                                                            <div class="confidence-bar flex-grow-1 mr-2">
                                                                <div class="<%= seg.cough_score >= 0.5 ? 'bg-success' : 'bg-warning' %>" 
                                                                     style="width: <%= (seg.cough_score * 100).toFixed(1) %>%; height: 100%; border-radius: 15px; transition: width 0.5s ease;">
                                                                </div>
                                                            </div>
                                                            <span class="font-weight-bold text-nowrap"><%= (seg.cough_score * 100).toFixed(1) %>%</span>
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <% if (seg.is_cough) { %>
                                                            <div class="d-flex align-items-center">
                                                                <div class="confidence-bar flex-grow-1 mr-2">
                                                                    <div class="<%= seg.tb_probability >= 0.5 ? 'bg-danger' : 'bg-info' %>" 
                                                                         style="width: <%= (seg.tb_probability * 100).toFixed(1) %>%; height: 100%; border-radius: 15px; transition: width 0.5s ease;">
                                                                    </div>
                                                                </div>
                                                                <span class="font-weight-bold text-nowrap"><%= (seg.tb_probability * 100).toFixed(1) %>%</span>
                                                            </div>
                                                        <% } else { %>
                                                            <span class="text-muted">N/A</span>
                                                        <% } %>
                                                    </td>
                                                    <td class="text-center">
                                                        <% if (seg.is_cough) { %>
                                                            <span class="badge badge-light" style="font-size: 1rem;">
                                                                <%= (seg.tb_probability * 100).toFixed(1) %>%
                                                            </span>
                                                        <% } else { %>
                                                            <span class="text-muted">-</span>
                                                        <% } %>
                                                    </td>
                                                    <td class="text-center">
                                                        <% if (seg.prediction === 'TB') { %>
                                                            <span class="badge badge-danger px-3 py-2">TB</span>
                                                        <% } else if (seg.prediction === 'NON-TB') { %>
                                                            <span class="badge badge-success px-3 py-2">NON-TB</span>
                                                        <% } else if (seg.prediction === 'NON-COUGH') { %>
                                                            <span class="badge badge-secondary px-3 py-2">NON-COUGH</span>
                                                        <% } else { %>
                                                            <span class="badge badge-warning px-3 py-2"><%= seg.prediction %></span>
                                                        <% } %>
                                                    </td>
                                                    <td class="text-center">
                                                        <% if (seg.is_cough) { %>
                                                            <canvas id="segmentChart_<%= idx %>" width="50" height="50"></canvas>
                                                        <% } else { %>
                                                            <span class="text-muted">-</span>
                                                        <% } %>
                                                    </td>
                                                </tr>
                                            <% }); %>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            <% } %>

            <!-- Waveform & MFCC Visualization -->
            <div class="row">
                <div class="col-lg-12">
                    <div class="iq-card viz-card">
                        <div class="iq-card-header">
                            <h5 class="card-title"><i class="ri-waveform-line"></i> Visualisasi Waveform Audio</h5>
                        </div>
                        <div class="iq-card-body">
                            <div id="waveform-visualization" style="height: 300px;"></div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-12">
                    <div class="iq-card viz-card">
                        <div class="iq-card-header">
                            <h5 class="card-title"><i class="ri-bar-chart-grouped-line"></i> Visualisasi MFCC Features</h5>
                        </div>
                        <div class="iq-card-body">
                            <div id="mfcc-visualization" style="height: 400px;"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="row">
                <div class="col-lg-12">
                    <div class="iq-card">
                        <div class="iq-card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <% if (typeof isHistoryView !== 'undefined' && isHistoryView) { %>
                                        <!-- Buttons for History View -->
                                        <a href="/tbcare/patient-history/<%= patient._id %>" class="btn btn-outline-secondary btn-lg">
                                            <i class="ri-arrow-left-line"></i> Back to Patient History
                                        </a>
                                        <a href="/tbcare/patient-history" class="btn btn-outline-primary btn-lg ml-2">
                                            <i class="ri-team-line"></i> All Patients
                                        </a>
                                    <% } else { %>
                                        <!-- Buttons for New Prediction -->
                                        <a href="/tbcare/predict" class="btn btn-outline-primary btn-lg">
                                            <i class="ri-arrow-left-line"></i> Analisis Audio Lain
                                        </a>
                                        <a href="/tbcare/patient-history" class="btn btn-outline-secondary btn-lg ml-2">
                                            <i class="ri-history-line"></i> Lihat Riwayat
                                        </a>
                                    <% } %>
                                </div>
                                <div>
                                    <button onclick="window.print()" class="btn btn-info btn-lg mr-2">
                                        <i class="ri-printer-line"></i> Print Laporan
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <%- include('../../includes/footer.ejs') %>
    </div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    // ========== PIE CHART: Segment Distribution ==========
    const segDistCtx = document.getElementById('segmentDistributionChart');
    if (segDistCtx) {
        new Chart(segDistCtx, {
            type: 'pie',
            data: {
                labels: ['TB Segments', 'Non-TB Segments', 'Non-Cough'],
                datasets: [{
                    data: [
                        <%= tbSegments %>, 
                        <%= nonTbSegments %>, 
                        <%= totalSegments - validCoughSegments %>
                    ],
                    backgroundColor: [
                        'rgba(245, 87, 108, 0.8)',  // TB - Red
                        'rgba(79, 172, 254, 0.8)',  // Non-TB - Blue
                        'rgba(169, 169, 169, 0.6)'  // Non-Cough - Gray
                    ],
                    borderColor: [
                        'rgba(245, 87, 108, 1)',
                        'rgba(79, 172, 254, 1)',
                        'rgba(169, 169, 169, 0.8)'
                    ],
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: { font: { size: 14 }, padding: 15 }
                    },
                    title: {
                        display: true,
                        text: 'Distribusi <%= totalSegments %> Segmen Audio',
                        font: { size: 16, weight: 'bold' }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.parsed || 0;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = ((value / total) * 100).toFixed(1);
                                return label + ': ' + value + ' (' + percentage + '%)';
                            }
                        }
                    }
                }
            }
        });
    }

    // ========== DOUGHNUT CHART: Overall Confidence ==========
    const confCtx = document.getElementById('confidenceChart');
    if (confCtx) {
        const confidence = <%= confidencePercentage %>;
        new Chart(confCtx, {
            type: 'doughnut',
            data: {
                labels: ['Confidence', 'Uncertainty'],
                datasets: [{
                    data: [confidence, 100 - confidence],
                    backgroundColor: [
                        '<%= prediction === "TB" ? "rgba(245, 87, 108, 0.8)" : "rgba(79, 172, 254, 0.8)" %>',
                        'rgba(233, 236, 239, 0.5)'
                    ],
                    borderColor: [
                        '<%= prediction === "TB" ? "rgba(245, 87, 108, 1)" : "rgba(79, 172, 254, 1)" %>',
                        'rgba(233, 236, 239, 0.8)'
                    ],
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: { font: { size: 14 }, padding: 15 }
                    },
                    title: {
                        display: true,
                        text: 'Tingkat Keyakinan Model',
                        font: { size: 16, weight: 'bold' }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.label + ': ' + context.parsed.toFixed(1) + '%';
                            }
                        }
                    }
                },
                cutout: '65%'
            },
            plugins: [{
                beforeDraw: function(chart) {
                    const width = chart.width;
                    const height = chart.height;
                    const ctx = chart.ctx;
                    ctx.restore();
                    const fontSize = (height / 114).toFixed(2);
                    ctx.font = 'bold ' + fontSize + 'em sans-serif';
                    ctx.textBaseline = 'middle';
                    const text = '<%= confidencePercentage %>%';
                    const textX = Math.round((width - ctx.measureText(text).width) / 2);
                    const textY = height / 2;
                    ctx.fillText(text, textX, textY);
                    ctx.save();
                }
            }]
        });
    }

    // ========== MINI PIE CHARTS: Per-Segment ==========
    <% if (segmentDetails && segmentDetails.length > 0) { %>
        <% segmentDetails.forEach(function(seg, idx) { %>
            <% if (seg.is_cough) { %>
                const segChart_<%= idx %> = document.getElementById('segmentChart_<%= idx %>');
                if (segChart_<%= idx %>) {
                    new Chart(segChart_<%= idx %>, {
                        type: 'doughnut',
                        data: {
                            datasets: [{
                                data: [
                                    <%= (seg.tb_probability * 100).toFixed(1) %>, 
                                    <%= (100 - seg.tb_probability * 100).toFixed(1) %>
                                ],
                                backgroundColor: [
                                    '<%= seg.tb_probability >= 0.5 ? "rgba(245, 87, 108, 0.8)" : "rgba(79, 172, 254, 0.8)" %>',
                                    'rgba(233, 236, 239, 0.3)'
                                ],
                                borderWidth: 0
                            }]
                        },
                        options: {
                            responsive: false,
                            plugins: { legend: { display: false }, tooltip: { enabled: false } },
                            cutout: '60%'
                        }
                    });
                }
            <% } %>
        <% }); %>
    <% } %>

    // ========== WAVEFORM VISUALIZATION ==========
    try {
        const waveData = JSON.parse(`<%- waveform %>`);
        if (waveData && waveData.length > 0) {
            Plotly.newPlot('waveform-visualization', [{
                y: waveData,
                type: 'line',
                line: { color: '#667eea', width: 1 },
                name: 'Amplitude'
            }], {
                title: { text: 'Audio Waveform', font: { size: 16 } },
                xaxis: { title: 'Sample (Time)', gridcolor: '#e9ecef' },
                yaxis: { title: 'Amplitude', gridcolor: '#e9ecef' },
                plot_bgcolor: '#f8f9fa',
                paper_bgcolor: 'white',
                margin: { l: 50, r: 30, t: 50, b: 50 }
            }, {
                displayModeBar: false,
                responsive: true
            });
        } else {
            document.getElementById('waveform-visualization').innerHTML = 
                '<p class="text-center text-muted py-5">No waveform data available</p>';
        }
    } catch (e) {
        console.error('Error rendering waveform:', e);
        document.getElementById('waveform-visualization').innerHTML = 
            '<p class="text-center text-danger py-5">Failed to load waveform visualization</p>';
    }

    // ========== MFCC VISUALIZATION ==========
    try {
        const mfccData = JSON.parse(`<%- mfcc %>`);
        if (mfccData && mfccData.length > 0) {
            Plotly.newPlot('mfcc-visualization', [{
                z: mfccData,
                type: 'heatmap',
                colorscale: 'Jet',
                colorbar: { title: 'Magnitude' }
            }], {
                title: { text: 'MFCC Features Heatmap', font: { size: 16 } },
                xaxis: { title: 'Time Frames', gridcolor: '#e9ecef' },
                yaxis: { title: 'MFCC Coefficients', gridcolor: '#e9ecef' },
                plot_bgcolor: '#f8f9fa',
                paper_bgcolor: 'white',
                margin: { l: 60, r: 60, t: 50, b: 50 }
            }, {
                displayModeBar: false,
                responsive: true
            });
        } else {
            document.getElementById('mfcc-visualization').innerHTML = 
                '<p class="text-center text-muted py-5">No MFCC data available</p>';
        }
    } catch (e) {
        console.error('Error rendering MFCC:', e);
        document.getElementById('mfcc-visualization').innerHTML = 
            '<p class="text-center text-danger py-5">Failed to load MFCC visualization</p>';
    }

    // ========== VALIDATION BUTTON HANDLER (Accept/Reject) ==========
    const validationBtns = document.querySelectorAll('.validation-action-btn');
    validationBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            const predictionId = this.dataset.id;
            const action = this.dataset.action; // 'accepted', 'rejected', or 'pending'
            
            const actionMessages = {
                accepted: 'menerima (ACCEPT)',
                rejected: 'menolak (REJECT)',
                pending: 'mereset status validasi'
            };
            
            const confirmMsg = `Apakah Anda yakin ingin ${actionMessages[action]} hasil prediksi ini?`;
            
            if (confirm(confirmMsg)) {
                const csrfToken = "<%= csrfToken %>";
                
                // Optional: ask for note if rejecting
                let note = null;
                if (action === 'rejected') {
                    note = prompt('Alasan penolakan (opsional):');
                }
                
                fetch('/api/prediction/' + predictionId + '/validate', {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'csrf-token': csrfToken
                    },
                    body: JSON.stringify({ 
                        validationStatus: action,
                        note: note 
                    })
                })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        alert(data.message);
                        location.reload();
                    } else {
                        alert('Error: ' + (data.message || 'Gagal mengupdate status validasi'));
                    }
                })
                .catch(err => {
                    console.error(err);
                    alert('Terjadi kesalahan saat mengupdate status validasi.');
                });
            }
        });
    });
});
</script>
<%- include('../../includes/tbcare/end.ejs') %>
